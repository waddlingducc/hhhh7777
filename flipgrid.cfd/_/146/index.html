<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>NebulaPlay</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&display=swap" rel="stylesheet"/>

<style>
  html, body {
    margin: 0; padding: 0;
    height: 100%; overflow: hidden;
    background: #000; /* actual bg set via JS */
  }

  /* Nav bar */
  nav {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 7vw;
    display: flex; align-items: center;
    backdrop-filter: blur(10px) saturate(200%) brightness(70%);
    padding: 0 1%;
    z-index: 10;
  }
  nav img { width: 95px; margin-right: 1%; border-radius: 1vw; }
  nav h3 { font-size: 4vw; font-weight: 800; color: white; font-family: 'Montserrat', sans-serif; margin: 0; }

  /* Layout under nav — reserve space for floating ad */
  .content {
    position: fixed; top: 7vw; left: 0; right: 0; bottom: 0;
    display: flex; gap: 20px; align-items: stretch;
    padding: 0 16px 16px 16px;
    box-sizing: border-box;
    margin-right: 300px; /* lane for ad */
  }

  /* Game area */
  .game-wrap {
    flex: 1 1 auto;
    display: flex; align-items: stretch; justify-content: center;
    min-width: 0; position: relative; background: #000;
    border-radius: 8px; overflow: hidden;
  }
  #unityContainer { width: 100%; height: 100%; }

  /* Loading text */
  #loading-text {
    position: absolute; top: 16px; left: 0; right: 0;
    text-align: center; color: white;
    font-size: clamp(18px, 3vw, 32px);
    font-family: cursive; z-index: 2; pointer-events: none;
    text-shadow: 0 2px 8px rgba(0,0,0,0.6);
  }

  /* Floating right ad — out of .content and above nav */
  .side-ad {
    position: fixed; top: 0; right: 0;
    width: 300px; height: 600px;
    z-index: 9999;
    display: flex; align-items: center; justify-content: center;
    border-radius: 8px; overflow: hidden;
    backdrop-filter: blur(6px) saturate(140%) brightness(85%);
  }
  .side-ad ins.adsbygoogle {
    display: inline-block !important; width: 300px !important; height: 600px !important;
  }
</style>

<!-- Kill any <base> tag immediately & keep it gone -->
<script>
  (function killBase() {
    const removeBase = () => { const b = document.querySelector('base'); if (b) b.remove(); };
    removeBase();
    new MutationObserver(removeBase).observe(document.head, { childList: true });
  })();
</script>

<!-- Slender game scripts (absolute URLs) -->
<script src="https://cdn.jsdelivr.net/gh/genizy/web-port@main/slender/TemplateData/UnityProgress.js"></script>
<script src="https://cdn.jsdelivr.net/gh/genizy/web-port@main/slender/Build/UnityLoader.js"></script>
<script>
  function mergeFiles(fileParts) {
    return new Promise((resolve, reject) => {
      const buffers = [];
      const next = (i) => {
        if (i >= fileParts.length) { resolve(URL.createObjectURL(new Blob(buffers))); return; }
        fetch(fileParts[i]).then(r => r.arrayBuffer()).then(buf => { buffers.push(buf); next(i+1); }).catch(reject);
      };
      next(0);
    });
  }
  function getParts(file, start, end) { const p=[]; for (let i=start;i<=end;i++) p.push(file+".part"+i); return p; }
  function resizeUnityContainer() {
    const el = document.getElementById("unityContainer");
    el.style.width = window.innerWidth + "px";
    el.style.height = window.innerHeight + "px";
  }
  Promise.all([
    mergeFiles(getParts("https://cdn.jsdelivr.net/gh/genizy/web-port@main/slender/Build/Build.data.unityweb", 1, 2))
  ]).then(([dataUrl]) => {
    const json = {
      companyName: "Parsec Productions",
      productName: "Slender",
      dataUrl: dataUrl,
      asmCodeUrl: "https://cdn.jsdelivr.net/gh/genizy/web-port@main/slender/Build/Build.asm.code.unityweb",
      asmMemoryUrl: "https://cdn.jsdelivr.net/gh/genizy/web-port@main/slender/Build/Build.asm.memory.unityweb",
      asmFrameworkUrl: "https://cdn.jsdelivr.net/gh/genizy/web-port@main/slender/Build/Build.asm.framework.unityweb",
      TOTAL_MEMORY: 268435456,
      graphicsAPI: ["WebGL 2.0", "WebGL 1.0"],
      webglContextAttributes: { preserveDrawingBuffer: false },
      splashScreenStyle: "Dark",
      backgroundColor: "#000000"
    };
    const blobUrl = URL.createObjectURL(new Blob([JSON.stringify(json)], { type: "application/json" }));
    window.addEventListener('resize', resizeUnityContainer);
    UnityLoader.instantiate("unityContainer", json, {
      onProgress: UnityProgress,
      url: blobUrl,
      Module: {
        onRuntimeInitialized: () => {
          resizeUnityContainer();
          const lt = document.getElementById("loading-text");
          if (lt) lt.remove();
        }
      }
    });
  });
</script>

<!-- Google Publisher Tag (GAM) -->
<script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>
<script>
  // --- Refresh config (tweakable) ---
  const SLOT_PATH   = '/23289777950/300x600';
  const SLOT_SIZE   = [300, 600];
  const SLOT_DIV_ID = 'div-gpt-ad-1757794050642-0';
  const INTERVAL_MS = 30000;   // 30s
  const MAX_REFRESH = 6;
  const MIN_VIEW_MS = 5000;    // ~5s viewable before refresh
  // ----------------------------------

  window.googletag = window.googletag || { cmd: [] };

  googletag.cmd.push(function() {
    const slot = googletag.defineSlot(SLOT_PATH, SLOT_SIZE, SLOT_DIV_ID)
      .addService(googletag.pubads());

    googletag.pubads().enableSingleRequest();

    // Page visibility gate
    let pageVisible = !document.hidden;
    document.addEventListener('visibilitychange', () => { pageVisible = !document.hidden; });

    // Viewability / in-view tracking
    let inView = true;
    let viewableSince = 0;

    googletag.pubads().addEventListener('impressionViewable', (e) => {
      if (e.slot === slot) {
        inView = true;
        viewableSince = performance.now();
      }
    });

    function attachObserverWhenReady() {
      const el = document.getElementById(SLOT_DIV_ID);
      if (!el) { setTimeout(attachObserverWhenReady, 50); return; }
      if ('IntersectionObserver' in window) {
        const io = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            inView = entry.isIntersecting && entry.intersectionRatio >= 0.5;
          });
        }, { threshold: [0.5] });
        io.observe(el);
      } else {
        inView = true;
      }
    }
    attachObserverWhenReady();

    // Start refresh cadence after first creative loads
    let refreshes = 0;
    let timer = null;

    googletag.pubads().addEventListener('slotOnload', (e) => {
      if (e.slot !== slot || timer) return;
      timer = setInterval(() => {
        if (!pageVisible) return;
        if (!inView) return;
        if (refreshes >= MAX_REFRESH) return;
        if (viewableSince && (performance.now() - viewableSince) < MIN_VIEW_MS) return;
        googletag.pubads().refresh([slot]);
        refreshes++;
      }, INTERVAL_MS);
    });

    googletag.enableServices();
  });
</script>
</head>
<body>
<nav>
  <a class="logo-link" data-href="/flipgrid.cfd/" style="cursor:pointer;">
    <img alt="logo" src="/images/logo.png"/>
  </a>
  <script>
    document.querySelectorAll('.logo-link').forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault();
        window.location.href = link.dataset.href;
      });
    });
  </script>
  <h3>www.Flipgrid.Cfd</h3>
</nav>

<div class="content">
  <!-- Game -->
  <div class="game-wrap" id="game-wrap">
    <div id="loading-text">LOADING...</div>
    <div id="unityContainer"></div>
  </div>
</div>

<!-- Floating Right Vertical Ad (out of .content) -->
<aside class="side-ad">
  <!-- /23289777950/300x600 -->
  <div id="div-gpt-ad-1757794050642-0" style="width:300px;height:600px;"></div>
  <script>
    // Ensure the slot div exists before display()
    (function onReady(fn){
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fn);
      } else { fn(); }
    })(function(){
      googletag = window.googletag || { cmd: [] };
      googletag.cmd.push(function() {
        googletag.display('div-gpt-ad-1757794050642-0');
      });
    });
  </script>
</aside>

<script>
  // Force your own domain for logo, home link, and background (works with or without "www")
  (function pinLocalAssets() {
    const ORIGIN = location.origin;
    const home = document.querySelector('.site-home');
    const logo = document.querySelector('.site-logo');
    if (home) home.href = ORIGIN + '/';
    if (logo) logo.src = ORIGIN + '/images/logo.png';
    document.body.style.background = `black url(${ORIGIN}/images/colour-dark-grey-mz-vf.jpg) center center / cover no-repeat fixed`;
  })();

  // Prevent right-click
  document.addEventListener("contextmenu", e => e.preventDefault());

  // Pointer lock on click
  const gameWrap = document.getElementById("game-wrap");
  gameWrap.addEventListener("click", () => {
    const req = gameWrap.requestPointerLock || gameWrap.mozRequestPointerLock || gameWrap.webkitRequestPointerLock;
    if (req) req.call(gameWrap);
  });
</script>
</body>
</html>
