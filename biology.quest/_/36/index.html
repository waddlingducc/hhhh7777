<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>NebulaPlay</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&display=swap" rel="stylesheet"/>

<style>
  html, body {
    margin: 0; padding: 0; height: 100%;
    overflow: hidden;
    background: black url(/images/colour-dark-grey-mz-vf.jpg) center center / cover no-repeat fixed;
  }

  /* Nav bar */
  nav {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 7vw; min-height: 60px;
    display: flex; align-items: center;
    backdrop-filter: blur(10px) saturate(200%) brightness(70%);
    padding: 0 1%; z-index: 10;
  }
  nav img { width: 95px; height: auto; margin-right: 1%; border-radius: 1vw; }
  nav h3 { font-size: 4vw; font-weight: 800; color: white; font-family: 'Montserrat', sans-serif; }

  /* Layout under nav — reserve space for the floating ad */
  .content {
    position: fixed; top: 7vw; left: 0; right: 0; bottom: 0;
    display: flex; gap: 20px; align-items: stretch;
    padding: 0 16px 16px 16px; box-sizing: border-box;
    margin-right: 300px; /* keep a 300px lane for the ad */
  }

  /* Game area */
  .game-wrap {
    flex: 1 1 auto;
    display: flex; align-items: stretch; justify-content: center;
    min-width: 0; position: relative; background: #000;
    border-radius: 8px; overflow: hidden;
  }
  #game_frame { width: 100%; height: 100%; position: relative; }
  #unity-canvas { width: 100%; height: 100%; display: block; outline: none; }

  /* Granny loading UI */
  #unity-container { position: absolute; inset: 0; }
  #unity-loading-bar {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 400px; height: 20px; background: rgba(0,0,0,.5);
    border: 2px solid #fff; border-radius: 10px; display: block;
  }
  #unity-logo { position: absolute; top: calc(50% - 100px); left: 50%; transform: translateX(-50%); width: 200px; }
  #unity-logo img { max-width: 100%; height: auto; }
  #unity-progress-bar-empty { width: 100%; height: 100%; position: relative; }
  #unity-progress-bar-full {
    position: absolute; top: 0; left: 0; width: 0%; height: 100%;
    background: #4caf50; border-radius: 8px; transition: width .3s ease;
  }
  #unity-warning {
    position: absolute; left: 50%; top: 5%; transform: translate(-50%);
    background: white; padding: 10px; display: none;
    border: 1px solid #ccc; border-radius: 5px; max-width: min(92vw, 600px);
  }

  /* Pointer-lock hint */
  .tap-hint {
    position: absolute; bottom: 12px; left: 0; right: 0;
    text-align: center; color: rgba(255,255,255,.9);
    font-size: 14px; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    pointer-events: none; text-shadow: 0 1px 4px rgba(0,0,0,.6);
    z-index: 4; display: none;
  }

  /* Floating right ad — out of .content and above nav */
  .side-ad {
    position: fixed;
    top: 0; right: 0;
    width: 300px; height: 600px;
    z-index: 9999; /* above nav & game */
    display: flex; align-items: center; justify-content: center;
    border-radius: 8px; overflow: hidden;
    backdrop-filter: blur(6px) saturate(140%) brightness(85%);
  }
  .side-ad ins.adsbygoogle {
    display: inline-block !important; width: 300px !important; height: 600px !important;
  }
</style>

<!-- GameMonetize SDK + options (kept) -->
<script src="https://cdn.jsdelivr.net/gh/gru6nny/ohd@main/sdk.js"></script>
<script>
  window.SDK_OPTIONS = {
    gameId: "jp112o3o4hzgrnc7zaewjkrfk282pul8",
    onEvent: function (a) {
      switch (a.name) {
        case "SDK_GAME_PAUSE":
          if (typeof myGameInstance !== 'undefined' && myGameInstance) {
            myGameInstance.SendMessage('AudioManager', 'MuteAudio');
          }
          break;
        case "SDK_GAME_START":
          if (typeof myGameInstance !== 'undefined' && myGameInstance) {
            myGameInstance.SendMessage('AudioManager', 'UnmuteAudio');
          }
          break;
      }
    }
  };
  (function (d, t, id) {
    var first = d.getElementsByTagName(t)[0];
    if (!d.getElementById(id)) {
      var s = d.createElement(t);
      s.id = id;
      s.src = "https://cdn.jsdelivr.net/gh/testamalame/sef@main/sedk.js";
      first.parentNode.insertBefore(s, first);
    }
  })(document, "script", "gamemonetize-sdk");
</script>

<!-- Google Publisher Tag (GAM) -->
<script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>
<script>
  // --- Refresh config (tweakable) ---
  const SLOT_PATH   = '/23289777950/300x600';
  const SLOT_SIZE   = [300, 600];
  const SLOT_DIV_ID = 'div-gpt-ad-1757794050642-0';
  const INTERVAL_MS = 30000;    // 30s
  const MAX_REFRESH = 6;
  const MIN_VIEW_MS = 5000;     // be viewable ~5s before refresh
  // ----------------------------------

  window.googletag = window.googletag || { cmd: [] };

  googletag.cmd.push(function() {
    const slot = googletag.defineSlot(SLOT_PATH, SLOT_SIZE, SLOT_DIV_ID)
      .addService(googletag.pubads());

    googletag.pubads().enableSingleRequest();

    // Gate on page visibility
    let pageVisible = !document.hidden;
    document.addEventListener('visibilitychange', () => { pageVisible = !document.hidden; });

    // Viewability / in-view tracking
    let inView = true;
    let viewableSince = 0;

    // Fires when 50%+ in view for ~1s
    googletag.pubads().addEventListener('impressionViewable', (e) => {
      if (e.slot === slot) {
        inView = true;
        viewableSince = performance.now();
      }
    });

    // Attach IntersectionObserver after the div exists
    function attachObserverWhenReady() {
      const el = document.getElementById(SLOT_DIV_ID);
      if (!el) { setTimeout(attachObserverWhenReady, 50); return; }
      if ('IntersectionObserver' in window) {
        const io = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            inView = entry.isIntersecting && entry.intersectionRatio >= 0.5;
          });
        }, { threshold: [0.5] });
        io.observe(el);
      } else {
        inView = true;
      }
    }
    attachObserverWhenReady();

    // Start refresh cadence after the first creative loads
    let refreshes = 0;
    let timer = null;

    googletag.pubads().addEventListener('slotOnload', (e) => {
      if (e.slot !== slot || timer) return;
      timer = setInterval(() => {
        if (!pageVisible) return;
        if (!inView) return;
        if (refreshes >= MAX_REFRESH) return;
        if (viewableSince && (performance.now() - viewableSince) < MIN_VIEW_MS) return;
        googletag.pubads().refresh([slot]);
        refreshes++;
      }, INTERVAL_MS);
    });

    googletag.enableServices();
  });
</script>
</head>
<body>
<nav>
  <a class="logo-link" data-href="/biology.quest/" style="cursor:pointer;">
    <img alt="logo" src="/images/logo.png"/>
  </a>
  <script>
    document.querySelectorAll('.logo-link').forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault();
        window.location.href = link.dataset.href;
      });
    });
  </script>
  <h3>www.Biology.Quest</h3>
</nav>

<div class="content">
  <!-- Game -->
  <div class="game-wrap">
    <div id="game_frame">
      <div id="unity-container">
        <canvas id="unity-canvas"></canvas>

        <!-- Loading UI -->
        <div id="unity-loading-bar">
          <div id="unity-logo">
            <img alt="Granny Logo" src="https://cdn.jsdelivr.net/gh/gru6nny/ohd@main/logo.png"/>
          </div>
          <div id="unity-progress-bar-empty">
            <div id="unity-progress-bar-full"></div>
          </div>
        </div>

        <div id="unity-warning"></div>
        <div class="tap-hint" id="tapHint"></div>
      </div>
    </div>
  </div>
</div>

<!-- Floating Right Vertical Ad (out of .content) -->
<aside class="side-ad">
  <!-- /23289777950/300x600 -->
  <div id="div-gpt-ad-1757794050642-0" style="width:300px;height:600px;"></div>
  <script>
    // Ensure the slot div exists before display()
    (function onReady(fn){
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fn);
      } else { fn(); }
    })(function(){
      googletag = window.googletag || { cmd: [] };
      googletag.cmd.push(function() {
        googletag.display('div-gpt-ad-1757794050642-0');
      });
    });
  </script>
</aside>

<!-- Granny loader + multi-part merge (UNCHANGED) -->
<script>
  const canvas = document.getElementById("unity-canvas");
  const loadingBar = document.getElementById("unity-loading-bar");
  const progressBarFull = document.getElementById("unity-progress-bar-full");
  const warningBanner = document.getElementById("unity-warning");
  const tapHint = document.getElementById("tapHint");

  let myGameInstance = null;
  let isAdShown = false;

  function unityShowBanner(msg, type) {
    var div = document.createElement('div');
    div.innerHTML = msg;
    warningBanner.appendChild(div);
    if (type === 'error') div.style = 'background: red; padding: 10px;';
    else {
      if (type === 'warning') div.style = 'background: yellow; padding: 10px;';
      setTimeout(() => { warningBanner.removeChild(div); }, 5000);
    }
    warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
  }

  function showAdOnClick() {
    if (!isAdShown && typeof sdk !== 'undefined' && typeof sdk.showBanner !== 'undefined') {
      sdk.showBanner(); isAdShown = true;
    }
  }

  // === Triple-click pointer lock ===
  let clickCount = 0;
  function setupPointerLockTripleClick() {
    tapHint.style.display = "block";
    tapHint.textContent = "";

    canvas.addEventListener('click', () => {
      clickCount++;
      if (clickCount === 1) {
        tapHint.textContent = "";
        showAdOnClick();
      } else if (clickCount === 2) {
        tapHint.textContent = "";
      } else if (clickCount === 3) {
        if (canvas.requestPointerLock) canvas.requestPointerLock();
      }
    });

    document.addEventListener('pointerlockchange', () => {
      const locked = document.pointerLockElement === canvas;
      if (locked) {
        tapHint.style.display = "none";
      } else {
        tapHint.style.display = "block";
        tapHint.textContent = "";
        clickCount = 0;
      }
    });
  }

  async function mergeUnityWebFiles(baseUrl, filePrefix, totalParts, extension) {
    const partUrls = [];
    for (let i = 1; i <= totalParts; i++) partUrls.push(`${baseUrl}/${filePrefix}_part${i}.${extension}`);

    const buffers = [];
    for (let i = 0; i < totalParts; i++) {
      const response = await fetch(partUrls[i]);
      const buffer = await response.arrayBuffer();
      buffers.push(buffer);
      const progress = ((i + 1) / totalParts) * 100;
      progressBarFull.style.width = `${progress}%`;
    }

    const totalLength = buffers.reduce((acc, b) => acc + b.byteLength, 0);
    const combinedBuffer = new Uint8Array(totalLength);
    let offset = 0;
    for (const buffer of buffers) {
      combinedBuffer.set(new Uint8Array(buffer), offset);
      offset += buffer.byteLength;
    }
    return combinedBuffer;
  }

  const buildUrl  = "https://cdn.jsdelivr.net/gh/gru6nny/ohd@main/Build";
  const loaderUrl = buildUrl + "/Granny.loader.js";

  async function initializeGame() {
    try {
      const dataBuffer = await mergeUnityWebFiles(buildUrl, "Granny", 2, "data");
      const wasmBuffer = await mergeUnityWebFiles(buildUrl, "Granny", 2, "wasm");

      const dataBlobUrl = URL.createObjectURL(new Blob([dataBuffer], { type: "application/octet-stream" }));
      const wasmBlobUrl = URL.createObjectURL(new Blob([wasmBuffer], { type: "application/octet-stream" }));

      const config = {
        dataUrl: dataBlobUrl,
        frameworkUrl: buildUrl + "/Granny.framework.js",
        codeUrl: wasmBlobUrl,
        streamingAssetsUrl: "https://cdn.jsdelivr.net/gh/gru6nny/ohd@main/StreamingAssets",
        companyName: "Anastasia Kazantseva",
        productName: "Granny",
        productVersion: "1.0",
        showBanner: unityShowBanner,
      };

      const script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          progressBarFull.style.width = (100 * progress) + "%";
        }).then((unityInstance) => {
          myGameInstance = unityInstance;
          loadingBar.style.display = "none";
          setupPointerLockTripleClick();
        }).catch((message) => { alert(message); });
      };
      document.body.appendChild(script);
    } catch (err) { console.error("Game initialization failed:", err); }
  }

  initializeGame();

  document.addEventListener("contextmenu", (e) => e.preventDefault());
</script>
</body>
</html>
