<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>NebulaPlay</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&display=swap" rel="stylesheet"/>

<style>
  html, body {
    margin: 0; padding: 0; height: 100%;
    overflow: hidden;
    background: black url(/images/colour-dark-grey-mz-vf.jpg) center center / cover no-repeat fixed;
  }

  /* Nav bar */
  nav {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 7vw;
    display: flex; align-items: center;
    backdrop-filter: blur(10px) saturate(200%) brightness(70%);
    padding: 0 1%;
    z-index: 10;
  }
  nav img {
    width: 95px; height: auto;
    margin-right: 1%;
    border-radius: 1vw;
  }
  nav h3 {
    font-size: 4vw; font-weight: 800; color: white;
    font-family: 'Montserrat', sans-serif;
  }

  /* Row under nav (reserve 300px for the floating ad) */
  .content {
    position: fixed;
    top: 7vw; left: 0; right: 0; bottom: 0;
    display: flex; gap: 20px; align-items: stretch;
    padding: 0 16px 16px 16px;
    box-sizing: border-box;
    margin-right: 300px; /* space for the 300x600 ad */
  }

  /* Game area */
  .game-wrap {
    flex: 1 1 auto;
    display: flex; align-items: stretch; justify-content: center;
    min-width: 0;
    position: relative;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
  }
  #game_frame { width: 100%; height: 100%; }

  /* Floating right ad — hovers above nav */
  .side-ad {
    position: fixed;
    top: 0; right: 0;
    width: 300px; height: 600px;
    z-index: 9999;
    display: flex; align-items: center; justify-content: center;
    border-radius: 8px; overflow: hidden;
    backdrop-filter: blur(6px) saturate(140%) brightness(85%);
  }
  .side-ad ins.adsbygoogle {
    display: inline-block !important;
    width: 300px !important;
    height: 600px !important;
  }
</style>

<!-- Google Publisher Tag (GAM) — load once -->
<script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>
<script>
  // Config
  const SLOT_PATH   = '/23289777950/300x600';
  const SLOT_SIZE   = [300, 600];
  const SLOT_DIV_ID = 'div-gpt-ad-1757794050642-0';
  const INTERVAL_MS = 30000;
  const MAX_REFRESHES = 6;

  window.googletag = window.googletag || {cmd: []};

  googletag.cmd.push(function() {
    const railSlot = googletag.defineSlot(SLOT_PATH, SLOT_SIZE, SLOT_DIV_ID)
      .addService(googletag.pubads());

    // SRA is fine with refresh; display once, then refresh the same slot.
    googletag.pubads().enableSingleRequest();

    // Helpful to avoid refresh when tab hidden
    let pageVisible = !document.hidden;
    document.addEventListener('visibilitychange', () => {
      pageVisible = !document.hidden;
    });

    // Viewability & in-view tracking
    let inView = true;   // default true; refined below
    let viewableSince = 0;

    // Gate on viewability event (fires when 50%+ in view for ~1s)
    googletag.pubads().addEventListener('impressionViewable', (e) => {
      if (e.slot === railSlot) {
        inView = true;
        viewableSince = performance.now();
      }
    });

    // Also use IntersectionObserver to keep inView updated
    function attachObserverWhenReady() {
      const el = document.getElementById(SLOT_DIV_ID);
      if (!el) {
        // Try again shortly until the div exists
        setTimeout(attachObserverWhenReady, 50);
        return;
      }
      if ('IntersectionObserver' in window) {
        const io = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            inView = entry.isIntersecting && entry.intersectionRatio >= 0.5;
          });
        }, { threshold: [0.5] });
        io.observe(el);
      } else {
        inView = true; // fallback
      }
    }
    attachObserverWhenReady();

    // Start the refresh loop only AFTER the first creative loads
    let refreshes = 0;
    let refreshTimer = null;

    googletag.pubads().addEventListener('slotOnload', (e) => {
      if (e.slot !== railSlot) return;
      if (refreshTimer) return; // already started

      refreshTimer = setInterval(() => {
        if (!pageVisible) return;
        if (!inView) return;
        if (refreshes >= MAX_REFRESHES) return;

        // Optional: make sure it's been viewable for at least ~5s before refresh
        if (viewableSince && performance.now() - viewableSince < 5000) return;

        googletag.pubads().refresh([railSlot]); // {changeCorrelator:false} not required
        refreshes++;
      }, INTERVAL_MS);
    });

    googletag.enableServices();
  });
</script>
</head>

<body>
  <nav>
    <a class="logo-link" data-href="/biology.quest/" style="cursor:pointer;">
      <img alt="logo" src="/images/logo.png"/>
    </a>
    <script>
      document.querySelectorAll('.logo-link').forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          window.location.href = link.dataset.href;
        });
      });
    </script>
    <h3>www.Biology.Quest</h3>
  </nav>

  <div class="content">
    <!-- Game (UNCHANGED) -->
    <div class="game-wrap">
      <div id="game_frame"></div>
    </div>
  </div>

  <!-- Floating Right Vertical Ad -->
  <aside class="side-ad">
    <!-- /23289777950/300x600 -->
    <div id="div-gpt-ad-1757794050642-0" style="width:300px;height:600px;"></div>
    <script>
      // Display after DOM is ready so the div exists for GPT
      (function onReady(fn){
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', fn);
        } else { fn(); }
      })(function(){
        googletag = window.googletag || {cmd: []};
        googletag.cmd.push(function() {
          googletag.display('div-gpt-ad-1757794050642-0');
        });
      });
    </script>
  </aside>

  <!-- Eaglercraft Loader (UNCHANGED) -->
  <script>
    window.disableUserscripts = true;
    window.__eaglercraftLoaderClient = {
      container: "game_frame",
      name: "Eaglercraft 1.12",
      file: "net.peytonplayz585.eaglercraft.v1_12.client",
      cid: "bafybeidrnchyech7b26rqhm3tayt7p6mxvl23lzd4f5mcyqda7hbrzyal4",
      path: "",
      download: "https://cdn.jsdelivr.net/gh/genizy/mc@main/data/1.12.2.gz",
      dlSize: 15601341,
      gzip: true
    };
  </script>
  <script src="https://cdn.jsdelivr.net/gh/genizy/mc@main/shared/loader.js"></script>

  <!-- Pointer lock (kept) -->
  <script>
    (function () {
      const gameFrame = document.getElementById("game_frame");

      const movementKeys = new Set(["KeyW","KeyA","KeyS","KeyD","Space","ShiftLeft","ShiftRight"]);
      let lastMoveKeyAt = 0;
      const MOVE_KEY_WINDOW_MS = 1200;

      window.addEventListener("keydown", (e) => {
        if (movementKeys.has(e.code)) lastMoveKeyAt = performance.now();
      }, { capture: true });

      function requestLock(canvas) {
        const lock = canvas.requestPointerLock || canvas.mozRequestPointerLock || canvas.webkitRequestPointerLock;
        if (lock) lock.call(canvas);
      }

      function shouldLock(event) {
        if (event.button === 1 || event.button === 2) return true;
        if (event.button === 0) return (performance.now() - lastMoveKeyAt) <= MOVE_KEY_WINDOW_MS;
        return false;
      }

      function attach() {
        const canvas = gameFrame.querySelector("canvas");
        if (!canvas) return false;

        const onPointerDown = (e) => {
          if (!shouldLock(e)) return;
          requestLock(canvas);
        };

        canvas.addEventListener("pointerdown", onPointerDown, { capture: true });
        gameFrame.addEventListener("pointerdown", onPointerDown, { capture: true });
        canvas.addEventListener("contextmenu", (e) => e.preventDefault());

        return true;
      }

      if (!attach()) {
        const mo = new MutationObserver(() => { if (attach()) mo.disconnect(); });
        mo.observe(gameFrame, { childList: true, subtree: true });
      }
    })();
  </script>
  <script>document.addEventListener("contextmenu", e => e.preventDefault());</script>
</body>
</html>
